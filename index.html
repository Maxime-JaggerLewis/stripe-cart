<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
        integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="modal.css">
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"
        integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"
        integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"
        integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<!-- Nav -->
<nav class="navbar navbar-inverse bg-inverse fixed-top bg-faded">
    <div class="row">
        <div class="col">
            <button id="open-cart" type="button" class="btn btn-primary" data-toggle="modal" data-target="#cart">Cart
                (<span class="total-count">0</span>)</button><button class="clear-cart btn btn-danger">Clear
                Cart</button>
        </div>
    </div>
</nav>


<!-- Main -->
<div class="container">
    <div class="product-list row">
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="cart" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Panier</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="product-cart">

                </div>
                <hr />
                <div>Frais d'activation <span id="activation-fees" class="align-right"></span></div>
                <hr />
                <div>Total<span id="total-cart" class="align-right"></span></div>
            </div>
            <div class="modal-footer">
                <button id="validate-cart" type="button" class="btn btn-primary">Finaliser la commande</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    class Product {
        constructor(name, price, image, subscription) {
            this.name = name;
            this.price = price;
            this.image = image;
            this.subscription = subscription;
        }
    }

    class ProductCart extends Product {
        constructor(product, count) {
            super(product.name, product.price, product.image, product.subscription)
            this.count = count;
        }
    }

    class ShoppingCart {
        constructor() {
            if (localStorage.getItem("shoppingCart")) {
                this.items = JSON.parse(localStorage.getItem("shoppingCart"))
            } else {
                this.items = []
            }
        }

        findItemIndexByName(name) {
            const itemIndex = this.items.findIndex((item) => {
                return item.name === name
            })
            return itemIndex
        }

        addItem(item, count = 1) {
            const itemIndex = this.findItemIndexByName(item.name)
            if (itemIndex < 0) {
                const cardProduct = new ProductCart(item, count)
                this.items.push(cardProduct)
            } else {
                this.items[itemIndex].count++
            }
            this.saveCart()
        }

        removeItem(item, count = 1) {
            const itemIndex = this.findItemIndexByName(item.name)
            if (itemIndex < -1) {
                throw new Error();
            }
            this.items.count -= count
            if (this.items.count <= 0) {
                this.clearItem(item);
            }
        }

        setItemCount(item, count) {
            const itemIndex = this.findItemIndexByName(item.name)
            if (itemIndex < -1) {
                throw new Error();
            }
            if (count < 0) {
                throw new Error();
            }
            if (count === 0) {
                this.removeItem(item)
            } else {
                this.items[itemIndex].count = count
            }
        }

        clearItem(item) {
            const itemIndex = this.findItemIndexByName(item.name)
            if (itemIndex < -1) {
                throw new Error();
            }
            this.items.slice(itemIndex, 1)
        }

        countItems() {
            let total = 0
            this.items.forEach(item => {
                total += item.count
            })
            return total
        }

        getTotalPrice() {
            let price = 0;
            this.items.forEach(item => {
                price += item.price * item.count
            })
            return price;
        }

        listItems() {

        }

        clear() {
            this.items = []
            this.saveCart();
        }

        saveCart() {
            localStorage.setItem('shoppingCart', JSON.stringify(this.items));
        }

        getCartStripeUrl() {
            const answer = fetch("http://0.0.0.0:3000/stripe/create-checkout-session", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ cart: this.items, mode: 'payment' })
            })
            return answer
        }
    }

    const getProductsFromStripe = () => {
        const answer = fetch("http://0.0.0.0:3000/stripe/products?livemode=false", {
            method: "GET",
            headers: { "Content-Type": "application/json" },
        })
        return answer
    }


    const shoppingCart = new ShoppingCart();

    const constructProductList = async () => {
        const products = await getProductsFromStripe()
        const productJSON = await products.json();
        const divProductList = document.getElementsByClassName('product-list')[0];

        for (const product of productJSON) {
            const divCol = document.createElement('div');
            divCol.classList.add('col')
            const divCard = document.createElement('div');
            divCard.classList.add('card')
            divCard.style = "width: 20rem;"
            const img = document.createElement('img');
            img.classList.add('card-img-top')
            img.alt = 'Card image cap'
            img.src = product.image ?? ""
            const divCardBlock = document.createElement('div');
            divCardBlock.classList.add('card-block')
            const title = document.createElement('h4')
            title.classList.add('card-title')
            title.textContent = product.name
            const price = document.createElement('p')
            price.classList.add('card-text')
            price.textContent = product.prices[0].price + product.prices[0].currency
            const button = document.createElement('a')
            button.href = "#"
            button.setAttribute('data-name', product.metadata ? product.metadata.name : product.name)
            button.setAttribute('data-price', product.prices[0].price)
            button.setAttribute('data-image', product.image ?? "")
            button.classList.add("add-to-cart", "btn", "btn-primary")
            button.onclick = (event) => {
                addToCart(event)
            }
            button.textContent = "Add to cart"

            divProductList.appendChild(divCol)
            divCol.appendChild(divCard)
            divCard.appendChild(img)
            divCard.appendChild(divCardBlock)
            divCardBlock.appendChild(title)
            divCardBlock.appendChild(price)
            divCardBlock.appendChild(button)
        }
    }
    constructProductList()

    const createCardTableProduct = (productCart) => {
        const divProductList = document.querySelector('.product-cart');
        const divProduct = document.createElement('div')
        divProduct.classList.add('product-cart-list')
        divProductList.appendChild(divProduct)
        const image = document.createElement('img')
        image.src = productCart.image;
        image.classList.add('cart-img')
        const productInfo = document.createElement('div')
        const name = document.createElement('div')
        name.textContent = productCart.name;
        const price = document.createElement('div')
        price.textContent = productCart.price + " â‚¬";
        const countDiv = document.createElement('div')
        countDiv.classList.add('quantity')
        const buttonMinus = document.createElement('button')
        buttonMinus.textContent = "-"
        buttonMinus.classList.add('btn', 'minus1')
        const buttonPlus = document.createElement('button')
        buttonPlus.classList.add('btn', 'add1')
        buttonPlus.textContent = "+"
        const count = document.createElement('input')
        count.classList.add('quantity')
        count.setAttribute('id', 'id_form-0-quantity')
        count.setAttribute('min', '1')
        count.setAttribute('name', 'form-0-quantity')
        count.setAttribute('value', productCart.count)
        count.setAttribute('type', 'number')
        countDiv.append(buttonMinus)
        countDiv.append(count)
        countDiv.append(buttonPlus)
        divProduct.appendChild(image)
        divProduct.appendChild(productInfo)
        productInfo.appendChild(name)
        productInfo.appendChild(price)
        divProduct.appendChild(countDiv)
    }

    const addToCart = (event) => {
        event.preventDefault();
        var name = event.target.getAttribute('data-name');
        var price = Number(event.target.getAttribute('data-price'));
        var img = event.target.getAttribute('data-image');
        shoppingCart.addItem(new Product(name, price, img), 1)
    }

    const redirectToStripe = async (event) => {
        event.preventDefault();
        const apiRes = await shoppingCart.getCartStripeUrl()
        const apiResJson = await apiRes.json()
        window.location.href = apiResJson.url
    }

    const showCart = document.getElementById('open-cart');
    showCart.onclick = (event) => {
        event.preventDefault();
        const divProductList = document.querySelector('.product-cart');
        divProductList.innerHTML = ""
        let total = shoppingCart.getTotalPrice();
        shoppingCart.items.forEach((item) => {
            createCardTableProduct(item);
            if (item.name === 'collar_jl2') {
                const fees = document.querySelector('#activation-fees')
                fees.textContent = 5 * item.count + "eur"
                total += (5 * item.count)
            }
        })
        const totalSpan = document.querySelector('#total-cart')
        totalSpan.textContent = total + "eur"
    }

    const clearCart = document.getElementsByClassName('clear-cart')[0];
    clearCart.onclick = (event) => {
        shoppingCart.clear();
    }

    const goToStripe = document.getElementById("validate-cart");
    goToStripe.onclick = (event) => {
        redirectToStripe(event)
    }
</script>